

In this task, the focus shifts to cases where a **predictable seed** is used to initialise PRNGs. If the seed is weak or predictable, an attacker can reproduce the entire sequence of random numbers, leading to severe vulnerabilities in systems that rely on these **random** values.

An example of the impact of predictable seeding is in `CAPTCHA` systems, where the random value determining the CAPTCHA challenge will be generated to detect a bot activity. If the seed used to initialise the PRNG is predictable, an attacker could predict the CAPTCHA values ahead of time, allowing them to bypass the CAPTCHA and access restricted areas of the application without solving it.

This issue also manifests in systems like lottery or game applications, where PRNGs determine the outcome of random draws. When these generators are seeded with predictable values, such as timestamps, attackers can manipulate the system by predicting the outcome, ensuring they win consistently. By exploiting the predictable PRNG seed, the attacker can reverse-engineer or replicate the same random sequence, breaking the system's fairness.

In this scenario, we will explore how using predictable seeds to generate tokens in a magic link login system can lead to account takeover. The magic link token is generated using PHP's [mt_rand()](https://www.php.net/manual/en/function.mt-rand.php) function, which is seeded with a combination of the CRC32 value of the user’s email address and a random constant. By analysing the token generation process, an attacker can reverse-engineer the seed and predict valid tokens.

To proceed with the attack, we need to decode the Base64 token and retrieve the original random number generated by the server. This number is the direct output of PHP’s `mt_rand()` function, which was seeded with a predictable value. You can use an online tool like [Base64 Decode](https://www.base64decode.org/) to quickly decode the token. Simply paste the Base64-encoded token (`MTEzNTUwODU0MQ==`) into the input field, and the decoded output will be displayed.

Once we have decoded the Base64 string, we are left with the original random number generated by mt_rand(), which, in our case, is `1135508541`. This number is crucial for the next step in the attack, as it is the output of a PRNG that was seeded using a dynamic value.  

## Exploitation

The primary tool we’ll use to exploit this vulnerability is [php_mt_seed](https://www.openwall.com/php_mt_seed/). This tool is specifically designed to crack the seed of PHP’s `mt_rand()` function based on the outputs of the random number generator. Once you provide `php_mt_seed` with a `mt_rand()` output, it calculates possible seed values that could have produced that output. You can learn detailed technical explanations and maths about the tool [here](https://www.ambionics.io/blog/php-mt-rand-prediction).

An updated version of `php_mt_seed` is already available on your AttackBox inside the `~/Rooms/InsecureRandomness` directory. If you are not using AttackBox, you can download the original version from [here](https://www.openwall.com/php_mt_seed/php_mt_seed-4.0.tar.gz). 

The next step with the tool setup is to crack the seed based on the decoded random number from the token. We know that the decoded random number from the base64 token was `1135508541`. This number is the direct output of `mt_rand()`. To find the seed, run the following command in the AttackBox, which takes a little over 5 minutes to show the result (You can skip it as well):

Terminal

           `root@attackbox:~/Rooms/InsecureRandomness# ./php_mt_seed 1135508541 Pattern: EXACT Version: 3.0.7 to 5.2.0 Found 0, trying 0xfc000000 - 0xffffffff, speed 7165.9 Mseeds/s   Version: 5.2.1+ Found 0, trying 0x30000000 - 0x31ffffff, speed 58.7 Mseeds/s  seed = 0x318ff649 = 831518281 (PHP 7.1.0+) Found 1, trying 0x38000000 - 0x39ffffff, speed 58.8 Mseeds/s  seed = 0x39dc3504 = 970732804 (PHP 7.1.0+) Found 2, trying 0x6c000000 - 0x6dffffff, speed 56.0 Mseeds/s  seed = 0x6d8817a7 = 1837635495 (PHP 7.1.0+) seed = 0x6d8817a7 = 1837635495 (PHP 7.1.0+) Found 4, trying 0xbe000000 - 0xbfffffff, speed 47.2 Mseeds/s  seed = 0xbe3249b3 = 3190966707 (PHP 7.1.0+) Found 5, trying 0xfe000000 - 0xffffffff, speed 44.9 Mseeds/s  Found 5`

`php_mt_seed` will output a list of possible seeds that could have generated the random number `1135508541`. This may take up to a few minutes, depending on the range of possible seeds. When using `php_mt_seed`, the tool generates multiple possible seeds because different seeds can produce the same initial random number. This happens due to the way `mt_rand()` is initialised. To accurately identify the correct seed, each one must be tested in the environment individually. In our case, the random number `1135508541` was generated through the seed `970732804`.

Once you have identified the correct seed, you can identify the constant value that the server used to prepare the seed. All you need to do is subtract the CRC32 value of `magic@mail.random.thm` from the identified seed. You can use this [CyberChef recipe](https://gchq.github.io/CyberChef/#recipe=CRC-32_Checksum\(\)From_Base\(16\)&ienc=65001&oeol=VT) to get the exact value.

![CRC32 checksum calculation.](https://tryhackme-images.s3.amazonaws.com/user-uploads/62a7685ca6e7ce005d3f3afe/room-content/62a7685ca6e7ce005d3f3afe-1727092016291.png)  

After getting the CRC32 value `970731467`, if we subtract it from the identified seed value `970732804`, we will get the constant value, which is `1337` in this case. 

An attacker only needs the target’s email address to log in as someone else. Once they have the email, the attacker can calculate the CRC32 of the email, add `1337` to it, and use the resulting seed with `mt_srand()`. This allows the attacker to predict the exact token generated for the target, enabling them to bypass authentication and log in as that user without knowing the password. 

In the AttackBox copy and paste the following PHP code to a file called `magic_link_login.php` and then use the command `php -S 0.0.0.0:8181` to utilise PHP's built-in web server for us to access the script. The script will generate 10 tokens based on a seed comprising a constant value and an email address. The script will accept the constant value and email as input and generate the corresponding tokens. To use the script, simply navigate to the following URL with your desired parameters `http://ATTACKBOX_IP:8181/magic_link_login.php?email={email}&constant={constant}`:  

```php
<?php
if (isset($_GET['email']) && isset($_GET['constant']) && is_numeric($_GET['constant'])) {
    $email = $_GET['email'];
    $constant = (int)$_GET['constant']; 

    if (filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $seed = crc32($email) + $constant;
        mt_srand($seed);

        echo "<h3>Predicted Magic Link Tokens for $email</h3>";
        for ($i = 0; $i < 10; $i++) {
            $random_number = mt_rand();
          
            $token = base64_encode($random_number);
            echo "Predicted magic link token " . ($i + 1) . ": " . $token . "<br>";
        }
    } else {
      
        echo "<div style='color:red;'>Invalid email format. Please provide a valid email.</div>";
    }
} else {
    echo "<div style='color:red;'>Please provide valid GET parameters: 'email' (valid email address) and 'constant' (numeric value).</div>";
}
?>
```

Now that you have the predicted token, you can log in as the target user. Simply visit the magic link URL [http://random.thm:8090/case/magic_link_login.php?token={predicted_token}](http://random.thm:8090/case/magic_link_login.php?token={predicted_token})  with the predicted token to log in without knowing the password.